<div class="constructor-page">
  <!-- Loading overlay -->
  <div *ngIf="isLoadingDesign" class="loading-overlay">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading design...</p>
  </div>

  <!-- Page header with breadcrumb -->
  <div class="page-header">
    <div class="breadcrumb">
      <mat-icon>palette</mat-icon>
      <span class="separator">/</span>
      <span class="current">
        {{ currentDesignId ? 'Edit Design' : 'New Design' }}
      </span>
      <span *ngIf="hasUnsavedChanges" class="unsaved-indicator">*</span>
    </div>

    <div class="header-actions">
      <button mat-button (click)="onCreateNew()" class="action-btn">
        <mat-icon>add</mat-icon>
        New
      </button>
      <button mat-button (click)="onViewSavedDesigns()" class="action-btn">
        <mat-icon>collections</mat-icon>
        My Designs
      </button>
    </div>
  </div>

  <!-- Main layout with sidebar and canvas -->
  <div class="constructor-layout">
    <!-- Left Sidebar - Tools -->
    <div class="sidebar sidebar-left">
      <!-- Colors Section -->
      <div class="sidebar-section">
        <h3 class="section-title">
          <mat-icon>palette</mat-icon>
          Colors
        </h3>

        <app-painting-panel
          [savedColors]="savedColors"
          (onSelectSavedColor)="selectColor($event)"
          (onColorDelete)="deleteColor($event)"
          (onSaveColor)="saveColor()"
          (onSetWhite)="setWhite()"
          [selectedColor]="selectedColor"
          (colorChanged)="selectedColor = $event"
        ></app-painting-panel>
      </div>

      <!-- Canvas Settings -->
      <div class="sidebar-section">
        <h3 class="section-title">
          <mat-icon>grid_on</mat-icon>
          Canvas Size
            <button
            mat-icon-button
            (click)="toggleLimitsInfo()"
            matTooltip="Size limits info"
            class="info-btn"
          >
            <mat-icon>info</mat-icon>
          </button>
        </h3>

                <!-- Limits info panel -->
        <div *ngIf="showLimitsInfo" class="limits-info">
          <div class="limits-card">
            <h4>Size Limits</h4>
            <ul class="limits-list">
              <li>
                Rows: {{ canvasLimits.minRows }}-{{ canvasLimits.maxRows }}
              </li>
              <li>
                Columns: {{ canvasLimits.minColumns }}-{{
                  canvasLimits.maxColumns
                }}
              </li>
              <li>Max cells: {{ canvasLimits.maxTotalCells }}</li>
            </ul>
            <p class="upgrade-hint">Upgrade to Premium for larger canvases!</p>
          </div>
        </div>

        <!-- Quick size presets -->
        <div class="size-presets">
          <h4>Quick Sizes</h4>
          <div class="preset-buttons">
            <button
              *ngFor="let size of recommendedSizes"
              mat-stroked-button
              (click)="setRecommendedSize(size.rows, size.columns)"
              class="preset-btn"
            >
              {{ size.label }}
            </button>
          </div>
        </div>

        <!-- Custom size controls -->

        <div class="size-controls">
           <h4>Custom Size</h4>

          <div class="size-input-row">
            <mat-form-field appearance="outline" class="size-field">
              <mat-label>Rows</mat-label>
              <input
                matInput
                type="number"
                [(ngModel)]="columnBeadsAmount"
                (ngModelChange)="onCanvasSizeChange()"
                [min]="canvasLimits.minRows"
                [max]="canvasLimits.maxRows"
                class="size-input"
              />
              <mat-hint>
                {{ canvasLimits.minRows }}-{{ canvasLimits.maxRows }}
              </mat-hint>
            </mat-form-field>

            <span class="size-separator">×</span>

            <mat-form-field appearance="outline" class="size-field">
              <mat-label>Columns</mat-label>
              <input
                matInput
                type="number"
                [(ngModel)]="rawBeadsAmount"
                (ngModelChange)="onCanvasSizeChange()"
                [min]="canvasLimits.minColumns"
                [max]="canvasLimits.maxColumns"
                class="size-input"
              />
              <mat-hint>
                {{ canvasLimits.minColumns }}-{{ canvasLimits.maxColumns }}
              </mat-hint>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="size-field">
            <mat-label>Rows</mat-label>
            <input
              matInput
              type="number"
              [(ngModel)]="columnBeadsAmount"
              (ngModelChange)="onCanvasSizeChange()"
              min="1"
              max="100"
              class="size-input"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="size-field">
            <mat-label>Columns</mat-label>
            <input
              matInput
              type="number"
              [(ngModel)]="rawBeadsAmount"
              (ngModelChange)="onCanvasSizeChange()"
              min="1"
              max="100"
              class="size-input"
            />
          </mat-form-field>

          <!-- <button
            mat-raised-button
            color="primary"
            (click)="setNewDimensions()"
            class="apply-size-btn"
          >
            <mat-icon>check</mat-icon>
            Apply
          </button> -->
        </div>

          <div class="canvas-info">
            <div class="info-item">
              <span class="info-label">Total beads:</span>
              <span class="info-value">
                {{ columnBeadsAmount * rawBeadsAmount }}
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">Aspect ratio:</span>
              <span class="info-value">
                {{ (rawBeadsAmount / columnBeadsAmount).toFixed(2) }}:1
              </span>
            </div>
          </div>

          <!-- Validation Messages -->
          <div *ngIf="validationErrors.length > 0" class="validation-errors">
            <div *ngFor="let error of validationErrors" class="error-message">
              <mat-icon color="warn">error</mat-icon>
              {{ error }}
            </div>
          </div>

          <div *ngIf="validationWarnings.length > 0" class="validation-warnings">
            <div *ngFor="let warning of validationWarnings" class="warning-message">
              <mat-icon color="accent">warning</mat-icon>
              {{ warning }}
            </div>
          </div>

          <!-- Performance warning -->
          <div *ngIf="performanceWarning" class="performance-warning">
            <mat-icon>speed</mat-icon>
            {{ performanceWarning }}
          </div>
          <button
            mat-raised-button
            color="primary"
            (click)="setNewDimensions()"
            [disabled]="!canApplyDimensions"
            class="apply-size-btn"
          >
            <mat-icon>check</mat-icon>
            Apply
          </button>
        </div>

        <div class="product-presets">
          <h4>Product Presets</h4>
          <div class="preset-categories">
            <div class="preset-category" *ngFor="let category of ['bracelet', 'choker', 'ring', 'earrings']">
              <h5>{{ category | titlecase }}</h5>
              <div class="preset-buttons">
                <button
                  mat-stroked-button
                  *ngFor="let preset of getRecommendedProductSizes()[category] | slice:0:3"
                  (click)="setProductSize(category, preset)"
                  class="preset-btn"
                >
                  {{ preset.rows }}×{{ preset.cols }}
                  <span class="preset-pattern">({{ preset.pattern }})</span>
                </button>
              </div>
            </div>
          </div>
        </div>

               <button
              *ngIf="!canApplyDimensions"
              mat-stroked-button
              (click)="constrainCanvasSize()"
              class="auto-fix-btn"
            >
              <mat-icon>auto_fix_high</mat-icon>
              Auto-fix
            </button>
        <!-- Limits Info -->
        <button
          mat-button
          (click)="toggleLimitsInfo()"
          class="limits-toggle"
        >
          <mat-icon>info</mat-icon>
          {{ showLimitsInfo ? 'Hide' : 'Show' }} Limits
        </button>

        <div *ngIf="showLimitsInfo" class="limits-info">
          <p><strong>Current Limits:</strong></p>
          <ul>
            <li>Max rows: {{ canvasLimits.maxRows }}</li>
            <li>Max columns: {{ canvasLimits.maxColumns }}</li>
            <li>Max cells: {{ canvasLimits.maxTotalCells }}</li>
          </ul>
        </div>
      </div>

      <!-- Weaving Pattern Selection -->
      <div class="sidebar-section">
        <h3 class="section-title">
          <mat-icon>pattern</mat-icon>
          Weaving Pattern
        </h3>

        <mat-button-toggle-group
          [value]="currentWeavingPattern().type"
          (change)="onWeavingPatternChange($event.value)"
          class="pattern-toggle-group"
          vertical
        >
          <mat-button-toggle
            *ngFor="let pattern of availablePatterns"
            [value]="pattern.type"
            class="pattern-toggle"
          >
            <div class="pattern-info">
              <div class="pattern-name">{{ pattern.name }}</div>
              <div class="pattern-description">{{ pattern.description }}</div>
              <div class="pattern-used-for">
                <small>Good for: {{ pattern.usedFor.slice(0, 2).join(', ') }}</small>
              </div>
            </div>
          </mat-button-toggle>
        </mat-button-toggle-group>

        <div class="current-pattern-details" *ngIf="currentWeavingPattern">
          <h4>Current Pattern Details:</h4>
          <p><strong>{{ currentWeavingPattern().name }}</strong></p>
          <p>{{ currentWeavingPattern().description }}</p>
          <div class="pattern-characteristics">
            <p><strong>Best for:</strong></p>
            <ul>
              <li *ngFor="let use of currentWeavingPattern().usedFor">{{ use }}</li>
            </ul>
          </div>
        </div>
      </div>
    

    <!-- Main Canvas Area -->
    <div class="canvas-area">
      <!-- Canvas toolbar -->
      <div class="canvas-toolbar">
        <div class="toolbar-left">
          <span class="canvas-info">
            {{ columnBeadsAmount }} × {{ rawBeadsAmount }} beads
            ({{ currentWeavingPattern().name }})
          </span>
          <span class="zoom-info">
            Zoom: {{ (viewportSettings().zoom * 100).toFixed(0) }}%
          </span>
        </div>

        <div class="toolbar-center">
          <!-- Grid Toggle -->
          <button
            mat-icon-button
            (click)="onToggleGrid()"
            [class.active]="showGrid"
            matTooltip="Toggle Grid"
            class="grid-btn"
          >
            <mat-icon>grid_on</mat-icon>
          </button>
        </div>

        <div class="toolbar-right">
          <button
            mat-icon-button
            (click)="onZoomOut()"
            matTooltip="Zoom Out"
            class="zoom-btn"
            [disabled]="viewportSettings().zoom <= viewportSettings().minZoom"
          >
            <mat-icon>zoom_out</mat-icon>
          </button>

          <button
            mat-icon-button
            (click)="onZoomIn()"
            matTooltip="Zoom In"
            class="zoom-btn"
            [disabled]="viewportSettings().zoom >= viewportSettings().maxZoom"
          >
            <mat-icon>zoom_in</mat-icon>
          </button>

          <button
            mat-icon-button
            (click)="onFitToScreen()"
            matTooltip="Fit to Screen"
            class="zoom-btn"
          >
            <mat-icon>fit_screen</mat-icon>
          </button>
        </div>
      </div>

      <!-- The actual canvas -->
      <div class="canvas-container">
        <div class="canvas-wrapper">
          <div class="canvas-grid" [ngStyle]="getCanvasStyles()">
            <app-beads-constructor
              [selectedColor]="selectedColor"
              [beadsColumnArray]="constructorConfig.beadsColumnArray"
              [beadsRawArray]="constructorConfig.beadsRawArray"
              [canvasArray]="constructorConfig.canvasArray"
              [cellStyles]="getCellStyles"
              [rowStyles]="getRowStyles"
              [showGrid]="showGrid"
              (colorChanged)="onColorChanged($event)"
            ></app-beads-constructor>
          </div>
        </div>
      </div>
    </div>
</div>

    <!-- Right Sidebar - Actions -->
    <div class="sidebar sidebar-right">
      <!-- Quick Actions -->
      <div class="sidebar-section">
        <h3 class="section-title">
          <mat-icon>build</mat-icon>
          Tools
        </h3>

        <div class="action-buttons">
          <button
            mat-raised-button
            color="warn"
            (click)="clearAllCanvas()"
            class="clear-btn"
          >
            <mat-icon>clear_all</mat-icon>
            Clear All
          </button>

          <button
            mat-raised-button
            color="primary"
            (click)="onDesignSave()"
            [disabled]="isSaving"
            class="save-btn"
          >
            <mat-icon *ngIf="isSaving" class="spinning">
              hourglass_empty
            </mat-icon>
            <mat-icon *ngIf="!isSaving">save</mat-icon>
            <span>{{ currentDesignId ? 'Update' : 'Save' }}</span>
          </button>
        </div>
      </div>

      <!-- Performance Info -->
      <div class="sidebar-section" *ngIf="performanceWarning">
        <h3 class="section-title">
          <mat-icon color="warn">warning</mat-icon>
          Performance
        </h3>
        <div class="performance-warning">
          <mat-icon color="warn">warning</mat-icon>
          <p>{{ performanceWarning }}</p>
        </div>
      </div>

      <!-- Pattern Library (future feature) -->
      <div class="sidebar-section">
        <h3 class="section-title">
          <mat-icon>auto_awesome</mat-icon>
          Patterns
        </h3>

        <div class="patterns-placeholder">
          <mat-icon class="placeholder-icon">construction</mat-icon>
          <p>Pattern library coming soon!</p>
        </div>
      </div>
    </div>


  </div>

<!-- Mobile floating action button -->
<div class="fab-container" fxHide fxShow.xs>
  <button
    mat-fab
    color="primary"
    (click)="onDesignSave()"
    [disabled]="isSaving"
    class="save-fab"
  >
    <mat-icon *ngIf="isSaving" class="spinning">hourglass_empty</mat-icon>
    <mat-icon *ngIf="!isSaving">save</mat-icon>
  </button>
</div>